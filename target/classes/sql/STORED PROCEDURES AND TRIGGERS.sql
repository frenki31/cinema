CREATE PROCEDURE SP_UPDATE_TOTAL_RATING 
AS
UPDATE MOVIE 
SET MOVIE_TOTAL_RATING = MOVIE_RATING * MOVIE_RATINGS_NR 

CREATE PROCEDURE SP_GET_MOVIE_ACTORS @title VARCHAR(250) 
AS
SELECT CONCAT(PERSON_FNAME,' ',PERSON_MNAME,' ',PERSON_LNAME) AS NAME, CAST_CHARACTER,PERSON_GENDER,CAST_ORDER 
FROM PERSON P
JOIN CAST C ON P.PERSON_ID = C.PERSON_ID
JOIN MOVIE M ON C.MOVIE_ID = M.MOVIE_ID
WHERE MOVIE_TITLE = @title 

CREATE TRIGGER TRG_INSERT_TOTAL_RATING 
ON MOVIE
FOR INSERT
AS
EXEC SP_UPDATE_TOTAL_RATING

CREATE TRIGGER TRG_UPDATE_RATING
ON MOVIE
FOR UPDATE
AS
DECLARE @ID INT
SET @ID = (SELECT MOVIE_ID FROM INSERTED)
IF UPDATE(MOVIE_RATINGS_NR)
UPDATE MOVIE 
SET MOVIE_RATING = CAST(MOVIE_TOTAL_RATING AS FLOAT) / CAST(MOVIE_RATINGS_NR AS FLOAT)
WHERE MOVIE.MOVIE_ID = @ID

CREATE PROCEDURE SP_GET_CREW
AS
SELECT MOVIE.MOVIE_ID,MOVIE.MOVIE_TITLE,PERSON.PERSON_ID,CONCAT(PERSON.PERSON_FNAME,' ',PERSON.PERSON_MNAME,' ',PERSON.PERSON_LNAME) AS NAME,DEPARTMENT.DEP_CODE,DEPARTMENT.DEP_NAME,CREW.CREW_JOBTITLE 
FROM CREW, MOVIE, PERSON,DEPARTMENT 
WHERE DEPARTMENT.DEP_CODE = CREW.DEP_CODE AND PERSON.PERSON_ID = CREW.PERSON_ID AND MOVIE.MOVIE_ID = CREW.MOVIE_ID